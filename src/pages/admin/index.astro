---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin Dashboard">
    <div id="admin-dashboard" class="min-h-screen bg-background text-text-main hidden">
        <!-- Header -->
        <header class="bg-surface shadow">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">Admin Dashboard</h1>
                <div class="flex items-center">
                    <span id="user-email" class="text-sm mr-4"></span>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">Logout</button>
                </div>
            </div>
        </header>
        <!-- Main Content -->
        <main class="container mx-auto p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Kelola Menu</h2>
                <button id="add-menu-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">+ Tambah Menu Baru</button>
            </div>
            <div id="menu-table-container" class="bg-surface p-4 rounded-lg border border-background"></div>
        </main>
    </div>

    <!-- Modal untuk Tambah/Edit Menu -->
    <div id="menu-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-surface p-8 rounded-lg shadow-lg w-full max-w-md border border-background">
            <h2 id="modal-title" class="text-2xl font-bold mb-6"></h2>
            <form id="menu-form">
                <input type="hidden" id="menu-id" name="id">
                <input type="hidden" id="existing-image-url" name="existing_image_url">
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-text-main/80 mb-2">Nama Menu</label>
                        <input type="text" id="name" name="name" required class="w-full bg-background border border-surface rounded-md p-2">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-text-main/80 mb-2">Harga</label>
                        <input type="number" id="price" name="price" required class="w-full bg-background border border-surface rounded-md p-2">
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-text-main/80 mb-2">Deskripsi</label>
                        <textarea id="description" name="description" rows="3" class="w-full bg-background border border-surface rounded-md p-2"></textarea>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label for="category" class="block text-sm font-medium text-text-main/80">Kategori</label>
                            <button type="button" id="show-add-category-btn" class="text-primary hover:text-primary/80 text-xs font-bold">+ Kategori Baru</button>
                        </div>
                        <select id="category" name="category_id" required class="w-full bg-background border border-surface rounded-md p-2"></select>
                        <div id="add-category-form-container" class="hidden mt-2 p-3 bg-background/50 rounded-md">
                            <input type="text" id="new-category-name" placeholder="Nama Kategori Baru" class="w-full bg-surface border-background rounded-md p-2 text-sm">
                            <input type="text" id="new-category-slug" placeholder="slug-kategori-baru" class="w-full bg-surface border-background rounded-md p-2 mt-2 text-sm">
                            <div class="flex justify-end space-x-2 mt-2">
                                <button type="button" id="cancel-add-category-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-xs">Batal</button>
                                <button type="button" id="save-category-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-xs font-bold">Simpan</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-main/80 mb-2">Gambar Menu</label>
                        <div id="image-preview-wrapper" class="relative w-32 mb-2 hidden">
                            <img id="image-preview" src="" alt="Image preview" class="w-32 h-32 object-cover rounded-md"/>
                            <button type="button" id="remove-image-btn" class="absolute top-0 right-0 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center -mt-2 -mr-2 hover:bg-red-700 transition-transform transform hover:scale-110">&times;</button>
                        </div>
                        <input type="file" id="image-file" name="image" accept="image/*" class="w-full text-sm text-text-main/60 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-background hover:file:bg-primary/90"/>
                        <p class="text-xs text-gray-500 mt-1">Kosongkan jika tidak ingin mengubah gambar.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-main/80 mb-2">Status</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="available" name="available" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ml-3 text-sm font-medium text-text-main">Tersedia</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Batal</button>
                    <button type="submit" id="submit-menu-btn" class="bg-primary hover:bg-primary/90 text-background font-bold py-2 px-4 rounded">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</Layout>

<script>
    // Script tidak berubah, hanya class di HTML yang diubah
    import { supabase } from '../../lib/supabase';

    const userEmailEl = document.getElementById('user-email');
    const adminDashboardEl = document.getElementById('admin-dashboard');
    const menuTableContainerEl = document.getElementById('menu-table-container');
    const menuModal = document.getElementById('menu-modal');
    const modalTitle = document.getElementById('modal-title');
    const menuForm = document.getElementById('menu-form') as HTMLFormElement;
    const cancelBtn = document.getElementById('cancel-btn');
    const addMenuBtn = document.getElementById('add-menu-btn');
    const categorySelect = document.getElementById('category') as HTMLSelectElement;
    const showAddCategoryBtn = document.getElementById('show-add-category-btn');
    const addCategoryContainer = document.getElementById('add-category-form-container');
    const saveCategoryBtn = document.getElementById('save-category-btn');
    const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');
    const menuIdInput = document.getElementById('menu-id') as HTMLInputElement;
    const availableCheckbox = document.getElementById('available') as HTMLInputElement;
    const imageFileInput = document.getElementById('image-file') as HTMLInputElement;
    const imagePreviewWrapper = document.getElementById('image-preview-wrapper');
    const imagePreview = document.getElementById('image-preview') as HTMLImageElement;
    const removeImageBtn = document.getElementById('remove-image-btn');
    const existingImageUrlInput = document.getElementById('existing-image-url') as HTMLInputElement;
    const submitMenuBtn = document.getElementById('submit-menu-btn');

    async function fetchCategories(selectAfterFetch = null) {
        const { data, error } = await supabase.from('categories').select('id, name').order('name');
        if (!error && data) {
            categorySelect.innerHTML = data.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            if (selectAfterFetch) { categorySelect.value = selectAfterFetch; }
        }
    }

    function openModalForCreate() {
        menuForm.reset();
        menuIdInput.value = '';
        modalTitle.textContent = 'Tambah Menu Baru';
        availableCheckbox.checked = true;
        imagePreviewWrapper.classList.add('hidden');
        imageFileInput.value = '';
        menuModal.classList.remove('hidden');
    }

    async function openModalForEdit(id) {
        const { data: menu, error } = await supabase.from('menus').select('*').eq('id', id).single();
        if (error || !menu) { alert('Gagal mengambil data menu!'); return; }
        menuForm.reset();
        menuIdInput.value = menu.id;
        existingImageUrlInput.value = menu.image_url;
        modalTitle.textContent = 'Edit Menu';
        (document.getElementById('name') as HTMLInputElement).value = menu.name;
        (document.getElementById('price') as HTMLInputElement).value = menu.price;
        (document.getElementById('description') as HTMLTextAreaElement).value = menu.description;
        categorySelect.value = menu.category_id;
        availableCheckbox.checked = menu.available;
        imageFileInput.value = '';
        if (menu.image_url) {
            imagePreview.src = menu.image_url;
            imagePreviewWrapper.classList.remove('hidden');
        } else {
            imagePreviewWrapper.classList.add('hidden');
        }
        menuModal.classList.remove('hidden');
    }

    function closeModal() { menuModal.classList.add('hidden'); }

    async function fetchAndDisplayMenus() {
        menuTableContainerEl.innerHTML = '<p>Memuat data menu...</p>';
        const { data: menus, error } = await supabase.from('menus').select('*, categories(name)').order('id', { ascending: true });
        if (error) { menuTableContainerEl.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; return; }
        if (!menus || menus.length === 0) { menuTableContainerEl.innerHTML = '<p>Belum ada menu.</p>'; return; }
        const tableHtml = `
            <table class="w-full text-left">
                <thead><tr class="border-b border-surface"><th class="p-2">Gambar</th><th class="p-2">Nama</th><th class="p-2">Harga</th><th class="p-2">Status</th><th class="p-2">Aksi</th></tr></thead>
                <tbody>
                    ${menus.map(menu => `
                        <tr class="border-b border-surface">
                            <td class="p-2 align-middle"><img src="${menu.image_url ? menu.image_url + '?width=100&height=100&resize=cover' : ''}" alt="${menu.name}" class="w-16 h-16 object-cover rounded-md"/></td>
                            <td class="p-2 align-middle">${menu.name}</td>
                            <td class="p-2 align-middle">Rp ${menu.price.toLocaleString('id-ID')}</td>
                            <td class="p-2 align-middle">${menu.available ? '<span class="bg-green-500/20 text-green-300 text-xs font-medium px-2.5 py-0.5 rounded-full">Tersedia</span>' : '<span class="bg-red-500/20 text-red-300 text-xs font-medium px-2.5 py-0.5 rounded-full">Habis</span>'}</td>
                            <td class="p-2 align-middle">
                                <div class="flex space-x-2">
                                    <button data-id="${menu.id}" class="edit-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-xs">Edit</button>
                                    <button data-id="${menu.id}" data-name="${menu.name}" class="delete-btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs">Hapus</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        menuTableContainerEl.innerHTML = tableHtml;
    }

    async function checkSession() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { window.location.href = '/admin/login'; }
        else {
            userEmailEl.textContent = `Login sebagai: ${user.email}`;
            adminDashboardEl.classList.remove('hidden');
            await fetchCategories();
            await fetchAndDisplayMenus();
        }
    }

    addMenuBtn.addEventListener('click', openModalForCreate);
    cancelBtn.addEventListener('click', closeModal);
    showAddCategoryBtn.addEventListener('click', () => { categorySelect.classList.add('hidden'); showAddCategoryBtn.classList.add('hidden'); addCategoryContainer.classList.remove('hidden'); });
    cancelAddCategoryBtn.addEventListener('click', () => { categorySelect.classList.remove('hidden'); showAddCategoryBtn.classList.remove('hidden'); addCategoryContainer.classList.add('hidden'); });
    imageFileInput.addEventListener('change', () => { const file = imageFileInput.files[0]; if (file) { imagePreview.src = URL.createObjectURL(file); imagePreviewWrapper.classList.remove('hidden'); } });
    removeImageBtn.addEventListener('click', () => { imageFileInput.value = ''; existingImageUrlInput.value = ''; imagePreviewWrapper.classList.add('hidden'); });

    saveCategoryBtn.addEventListener('click', async () => {
        const nameInput = document.getElementById('new-category-name') as HTMLInputElement;
        const slugInput = document.getElementById('new-category-slug') as HTMLInputElement;
        if (!nameInput.value || !slugInput.value) { alert('Nama dan slug kategori tidak boleh kosong.'); return; }
        const { data, error } = await supabase.from('categories').insert({ name: nameInput.value, slug: slugInput.value }).select().single();
        if (error) { alert(`Gagal menyimpan kategori: ${error.message}`); }
        else if (data) {
            nameInput.value = ''; slugInput.value = '';
            addCategoryContainer.classList.add('hidden');
            categorySelect.classList.remove('hidden');
            showAddCategoryBtn.classList.remove('hidden');
            await fetchCategories(data.id);
        }
    });

    menuForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitMenuBtn.setAttribute('disabled', 'true');
        submitMenuBtn.textContent = 'Menyimpan...';
        const formData = new FormData(menuForm);
        const id = formData.get('id');
        let imageUrl = formData.get('existing_image_url') as string;

        try {
            const imageFile = imageFileInput.files[0];
            if (imageFile) {
                const fileName = `${Date.now()}-${imageFile.name}`;
                const { error: uploadError } = await supabase.storage.from('menu-images').upload(fileName, imageFile);
                if (uploadError) throw new Error(`Gagal upload file: ${uploadError.message}`);
                const { data: urlData } = supabase.storage.from('menu-images').getPublicUrl(fileName);
                imageUrl = urlData.publicUrl;
            } else if (existingImageUrlInput.value === '') {
                imageUrl = null;
            }

            const menuData = { name: formData.get('name'), price: formData.get('price'), description: formData.get('description'), category_id: formData.get('category_id'), available: availableCheckbox.checked, image_url: imageUrl };
            const { error } = id ? await supabase.from('menus').update(menuData).match({ id }) : await supabase.from('menus').insert(menuData);
            if (error) throw error;
            closeModal();
            fetchAndDisplayMenus();
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            submitMenuBtn.removeAttribute('disabled');
            submitMenuBtn.textContent = 'Simpan';
        }
    });

    menuTableContainerEl.addEventListener('click', async (e) => {
        const target = e.target as HTMLElement;
        const id = target.dataset.id;
        if (target.classList.contains('edit-btn')) { openModalForEdit(id); }
        else if (target.classList.contains('delete-btn')) {
            const menuName = target.dataset.name;
            if (window.confirm(`Yakin mau menghapus menu "${menuName}"?`)) {
                await supabase.from('menus').delete().match({ id });
                fetchAndDisplayMenus();
            }
        }
    });

    document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = '/admin/login';
    });

    checkSession();

</script>