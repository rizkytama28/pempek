---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import MenuCard from '../components/MenuCard.astro';
import { supabase } from '../lib/supabase';

// Ambil data menu asli dari Supabase saat halaman di-build
const { data: menus, error } = await supabase
    .from('menus')
    .select('*, categories(name)')
    .order('id', { ascending: true });

// Ambil semua kategori untuk filter
const { data: categories } = await supabase.from('categories').select('id, name').order('name');

---

<Layout title="Menu - Pempek.in">
	<Header />
	<main class="container mx-auto p-4">
		<h1 class="text-4xl font-bold my-8 text-center">Menu Kami</h1>

		<div class="bg-surface p-4 sm:p-6 rounded-lg mb-8 max-w-4xl mx-auto text-center">
			<h2 class="text-2xl font-bold mb-3 text-primary">Cara Pesan</h2>
			<ol class="text-left space-y-2 text-text-main/90 list-decimal list-inside">
				<li>Pilih menu dan jumlah yang Anda inginkan dengan menekan tombol <strong>"+"</strong> pada kartu menu.</li>
				<li>Klik tombol <strong>"Pesan Sekarang"</strong> yang muncul di pojok kanan bawah layar.</li>
				<li>Anda akan diarahkan ke WhatsApp dengan rincian pesanan Anda. Cukup kirim pesan tersebut!</li>
				<li>Tunggu konfirmasi dari kami mengenai total pembayaran dan detail pengiriman/pengambilan.</li>
			</ol>
		</div>
		
        {error && <p class="text-center text-red-500">Gagal memuat menu: {error.message}</p>}

        <!-- Sticky Filter Dropdown -->
        <div class="sticky top-20 bg-background/80 backdrop-blur-sm py-4 z-40 mb-8">
            <div class="max-w-sm mx-auto">
                <label for="category-filter" class="sr-only">Pilih Kategori</label>
                <select id="category-filter" class="w-full bg-surface border border-primary rounded-md p-2 text-text-main focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="all">Semua Kategori</option>
                    {categories && categories.map(category => (
                        <option value={category.name}>{category.name}</option>
                    ))}
                </select>
            </div>
        </div>

        {menus && menus.length > 0 ? (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="menu-grid">
                {menus.map(item => (
                    <div class="menu-item" data-category={item.categories?.name || 'uncategorized'}>
                        <MenuCard item={item} />
                    </div>
                ))}
            </div>
        ) : (
            <p class="text-center text-gray-400">Belum ada menu yang tersedia saat ini.</p>
        )}

	</main>
</Layout>

<script>
    const categoryFilter = document.getElementById('category-filter');
    const menuItems = document.querySelectorAll('.menu-item');

    categoryFilter.addEventListener('change', (event) => {
        const selectedCategory = (event.target as HTMLSelectElement).value;

        menuItems.forEach(item => {
            const itemCategory = item.getAttribute('data-category');
            if (selectedCategory === 'all' || itemCategory === selectedCategory) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>
